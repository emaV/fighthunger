<?php

function gathering_init(){
  global $user;
  if ((!isset($user->first_name)) || (!isset($user->last_name))){
    _gathering_user_loadnames($user);
  }
}

function gathering_settings(){
  // TODO- make all of this editable per-campaign
  $iform = form_textfield(t("Subject"),"gathering_invite_subj",variable_get("gathering_invite_subj",""),100,128);
  
  $iform .= form_textarea(t("Default Message"),"gathering_invite_message",variable_get("gathering_invite_message",""),80,20);

  $out = form_group("Invitations",$iform);

  $wform = form_textfield(t("Subject"),"gathering_welcome_subj",variable_get("gathering_welcome_subj",""),100,128);
  
  $wform .= form_textarea(t("Default Message"),"gathering_welcome_message",variable_get("gathering_welcome_message",""),80,20,"Use this codes: %confirmurl, %firstname, %lastname");

  $wform .= "This email will be sent to users when they create a new event. Leave either of these fields blank to disable welcome messages.";

  $out .= form_group("Welcome Message",$wform);

  return $out;  
}

// implementation of hook_block
function gathering_block($op = 'list', $delta = 0, $edit = array()){
  if ($op == "list") {
    $blocks[0]['info'] = "Gathering attendee list";
    $blocks[1]['info'] = "Gathering related links";
    $blocks[2]['info'] = "Gathering country list";
    return $blocks;
  } elseif($op == "view"){
    switch ($delta) {
      case 0:
        return gathering_block_attendees();
        break;
      case 1:
        return _gathering_block_related_links();
        break;
      case 2:
        return _gathering_block_countries();
        break;
    }
  } else if ($op == 'configure') {
    switch ($delta) {
      case 0:
        return _gathering_block_attendees_settings();
        break;
      case 2:
        return _gathering_block_countries_settings();
        break;
    }
  } else if ($op == 'save') {
    switch ($delta) {
      case 0:
        variable_set('gathering_block_attendees_max', $edit['gathering_block_attendees_max']);
        variable_set('gathering_block_attendees_title', $edit['gathering_block_attendees_title']);
        break;
      case 2:
        variable_set('gathering_block_countries_title', $edit['gathering_block_countries_title']);
        variable_set('gathering_block_countries_campaign', $edit['gathering_block_countries_campaign']);
        variable_set('gathering_block_countries_description_show', $edit['gathering_block_countries_description_show']);
        $SQL = 'SELECT description FROM {gathering_campaign} where camid=%d;';
        $row = db_fetch_object(db_query($SQL, $edit['gathering_block_countries_campaign']));
        variable_set('gathering_block_countries_description', $row->description);
        break;
    }
  }
}

// creates the attendees block
// returns false when the block should be hidden
// called by gathering_block
function gathering_block_attendees() {
  // TODO make this more themeable
  
  $out = false;
  
  if ((arg(0) == "node") && (is_numeric(arg(1)))){
    $signups = _gathering_get_signups(arg(1));
    if ($signups) {
      // only show $max attendees
      $max_no = variable_get('gathering_block_attendees_max', 0);
      $max = ($max_no>0) ? $max_no : count($signups);
      for($i=0;$i<$max;$i++){
        $s = $signups[$i];
        if (!empty($s)){
          $user = user_load(array("uid"=>$s['uid']));
          unset($item);
          $item = theme("name",$user);
          if ($s['guests'] > 0){
            $item .= " (+".$s['guests']." ".t("guests").")";
          }
          if ($s['opencomment']){
            $item .= ":<br/>".$s['comment'];
          }
          $items[] = $item;
        }
      }
      $out['subject'] = variable_get('gathering_block_attendees_title', t('walkers'));
      $out['content'] = theme("item_list",$items);
      if ( ($max_no>0) && ($max_no < count($signups)) ) {
        $out['content'] .= t('and ') . " " . (count($signups) - $max_no) . " " .t('walkers');
      } 
    }
  }
  return $out;
}

function _gathering_block_attendees_settings() {
    $output = form_textfield(t('Max Number of users shown'),'gathering_block_attendees_max', variable_get('gathering_block_attendees_max', 0),30,50,t('Select Maxim number of user shown in attendees block (0 for all)'));
    $output .= form_textfield(t('Block title'),'gathering_block_attendees_title', variable_get('gathering_block_attendees_title', t('walkers')),30,50,t('Select block title'));
    return $output;
} 

// creates the related links block
// returns false when the block should be hidden
// called by gathering_block
function _gathering_block_related_links() {
  
  $out = false;
  $area_links = "";
  
  if ((arg(0) == "node") && (is_numeric(arg(1)))) {
    $SQL = "SELECT * FROM {gathering_area_related} AS a INNER JOIN {gathering_node} AS n ON a.ccid=n.country WHERE nid = %d";
    db_rewrite_sql($SQL);
    $result = db_query($SQL, arg(1));
    if(db_num_rows($result)>0) {
      while ($area = db_fetch_object($result))  {
        if (strpos($area->linkaddress, "http")===0) {
          $area_links[] = l($area->name,$area->linkaddress);
        } else {
          $area_links[] = l($area->name,"local/$area->linkaddress");
        }
        $out['subject'] = t('Related links');
        $out['content'] = theme("item_list",$area_links);
      }
    }
  }
  return $out;
}

// creates countries list block
// returns false when the block should be hidden
// called by gathering_block
function _gathering_block_countries() {
  
  $out = false;
  $country_list="";
  $camid = variable_get('gathering_block_countries_campaign', 1);
  $SQL = "SELECT c.name AS name, gn.country AS ccid, COUNT(gn.nid) AS count FROM {gathering_node} AS gn LEFT JOIN {countries} AS c ON gn.country=c.ccid WHERE gn.camid = %d GROUP BY (gn.country) ORDER BY c.name;";
  db_rewrite_sql($SQL);
  $result = db_query($SQL, $camid);
  if(db_num_rows($result)>0) {
    while ($row = db_fetch_object($result))  {
      $country_list[] = l("$row->name ($row->count)","gathering/home/$camid/$row->ccid");
    }
    $out['subject'] = t(variable_get('gathering_block_countries_title', 'Countries'));
    if (variable_get('gathering_block_countries_description_show', 1)) {
      $out['content'] = '<p>' . t(variable_get('gathering_block_countries_description','')) . '</p>';
    } else {
      $out['content'] = '';
    }
    $out['content'] .= theme("item_list",$country_list);
  } 
  return $out;
}

function _gathering_block_countries_settings() {
    $campaign_list = "";
    $SQL = 'SELECT camid, name, description FROM {gathering_campaign};';
    $result = db_query($SQL);
    if(db_num_rows($result)>0) {
      while ($row = db_fetch_object($result)) {
        $campaign_list[$row->camid] = $row->name;
      }
    }
    $output = form_textfield(t('Select Title'),'gathering_block_countries_title', variable_get('gathering_block_countries_title', 'Countries'),30,50,t('Select box title'));
    $output .= form_select(t('Select Campaign'), 'gathering_block_countries_campaign', variable_get('gathering_block_countries_campaign', 1), $campaign_list, t('Select a campaign'));
    $output .= form_checkbox(t('Show Description'), 'gathering_block_countries_description_show', 1, variable_get('gathering_block_countries_description_show', 1), t('Show default description'));
    return $output;
}

function theme_name($user){  
  $name = $user->first_name." ".substr($user->last_name,0,1).".";
  
  if (user_access("access user profiles")){
    $out = l($name,"user/".$user->uid);
  } else {
    $out = $name;
  }
  
  return $out;
}

// implementation of hook_user
// enters walk list into user profiles
function gathering_user($op, &$edit, &$user, $category = NULL){
  switch ($op){
    case "load":
      _gathering_user_loadnames($user);
      break;
    case "view":
      // return list of this user's gatherings
      $campaigns = _gathering_get_campaigns();
      foreach($campaigns as $c){
        $status = _gathering_user_statusreport($c['camid'],$user);
        if (!empty($status)){
          $out[$c['name']] = $status;
        }
      } 
      break;
  }
  return $out;
}

// utility function, adds name data to user object
function _gathering_user_loadnames(&$user){
  // our version of civicrm has a BUG in how it handles first_name and last_name
  // http://objectledge.org/jira/browse/CRM-744
  // so we must parse these variables out from display_name until this is fixed
  if (module_exist('civicrm')) {
    // get CivicRM data
    // get contact object
    civicrm_initialize(TRUE);
    $param['email'] = $user->mail;
    $c = crm_get_contact($param);

    // get name data
    $name_array = explode(", ",$c->sort_name);
    $user->first_name = $name_array[1];
    if (!valid_email_address($name_array[0])){
      $user->last_name = $name_array[0];
    }
    
    // get phone data, by parsing civicrm's obtuse data structure
    $location_a = $c->location;
    if (is_array($location_a)){
      $location = array_pop($location_a);
      $phone_a = $location->phone;
      if (is_array($phone_a)){
        $phone = array_pop($phone_a);
        $user->phone = $phone->phone;
      }
    }    
  }
}

// implementation of hook_help
function gathering_help($sec){
  $campaigns = _gathering_get_campaigns();
  foreach ($campaigns as $c){
    $out['node/add#'.$c['nodetype']] = $c['description'];
  }
  
  return t($out[$sec]);
}


// implementation of hook_node_name
function gathering_node_name($node){
  if (is_string($node)){
    $type = $node;
  } else {
    $type = $node->type;
  }

  // parse campaign_id from node->type
  $camid = _gathering_get_camid($type);
  
  $campaigns = _gathering_get_campaigns();
  $out = $campaigns[$camid]['eventname'] . " - " . $campaigns[$camid]['name'];
  return $out;
}

// implementation of hook_node_types
function gathering_node_types(){
  $campaigns = _gathering_get_campaigns();
  foreach ($campaigns as $c){
    $out[] = "gathering-".$c['camid'];
  } 
  
  return $out;
}

// implementation of hook_access
// TODO make this correct
function gathering_access($op, $node){
  global $user;
  return _gathering_user_access($op,$node,$user);
}

// implementation of hook_menu
function gathering_menu($mc){
  if ($mc){
    $out[] = array(
      'title'     => t('gathering campaigns'),
      'callback'  => 'gathering_admin',
      'access'    => user_access("administer site configuration"),
      'type'      => MENU_NORMAL_ITEM,
      'path'      => 'admin/gathering'
    );
    $out[] = array(
      'title'     => t('gathering reports'),
      'callback'  => 'gathering_reports',
      'access'    => user_access("administer gathering campaigns"),
      'type'      => MENU_NORMAL_ITEM,
      'path'      => 'admin/gathering_reports'
    );
    $out[] = array(
      'callback'  => 'gathering_page',
      'access'    => true,
      'type'      => MENU_CALLBACK,
      'path'      => 'gathering'
    );
  } else {
    $out = _gathering_menu_campaign();
  }
  return $out;
}

// implementation of hook_perm
function gathering_perm(){
  $out = array("administer gathering campaigns",
               "administer gathering signups",
               "create gatherings",
               "create multiple gatherings per campaign",
               "send and receive GatheringMessages",
               "edit own gatherings");
  return $out;
}

// implementation of hook_validate
function gathering_validate(&$node){
  // build required fields
  $required_fields[] = array(
    'name' => "Start Time",
    'variable'     => "starttime"
  );
  $required_fields[] = array(
    'name' => "End Time",
    'variable'     => "endtime"
  );
  $required_fields[] = array(
    'name' => "Start Time",
    'variable'     => "starttime"
  );
  $required_fields[] = array(
    'name' => "Start Location",
    'variable'     => "address1"
  );
  $required_fields[] = array(
    'name' => "Street Address",
    'variable'     => "address2"
  );
  $required_fields[] = array(
    'name' => "City",
    'variable'     => "city"
  );
/*
  $required_fields[] = array(
    'name' => "State",
    'variable'     => "state"
  );
  */
  foreach ($required_fields as $f){
    $v = $f['variable'];
    if (isset($node->$v) && (empty($node->$v))){
      form_set_error($v,t("Please enter a ".$f['name']."."));
    }
  }
  
  // validate country field
  if ($node->country == "--"){
    form_set_error("country",t("Please select a Country."));
  }

  // TODO - validate time fields

}

// implementation of hook_form
function gathering_form(&$node,$showtitle=false){
  if ((!isset($node->country)) && isset($_GET['c'])){
    $node->country = $_GET['c'];
  }

  if ($showtitle){
    $form1  = form_textfield(t("Event Name"),"title","",40,64,"A title for your event.");
  }
  $form1 .= form_textfield(t("City"),"city",$node->city,30,50,t('If you are in the US, include your state here.<br/>For example: "Denver, CO"'),NULL,TRUE);
  $form1 .= form_select(t("Country"),"country",$node->country,_gathering_get_countries(),NULL,NULL,NULL,TRUE);
  
  $output .= form_group(t("Basic Information"),$form1);

  $starttime_display = _gathering_time_display($node->starttime);
  $endtime_display = _gathering_time_display($node->endtime);
  $form2  = form_textfield(t("Start Time"),"starttime",$starttime_display,20,10,"local time (ex. 11:00 AM)",NULL,TRUE);
  $form2 .= form_textfield(t("End Time"),"endtime",$endtime_display,20,10,"local time (ex. 1:45 PM)",NULL,TRUE);
    
  $form2 .= form_textfield(t("Start Location"),"address1",$node->address1,30,50,"The name of the specific place where participants will meet (e.g. Central Fountain).",NULL,TRUE);
  $form2 .= form_textfield(t("Street Address"),"address2",$node->address2,30,100,NULL,NULL,TRUE);
  $form2 .= form_textarea("Route","route",$node->route,40,2,"Describe the general route for your walk, including approximate length and any landmarks.");
//  $output .= form_textfield(t("State / Province"),"state",$node->state,30,50,NULL,NULL,TRUE);
  $output .= form_group(t("When & Where"),$form2);

  $form3 .= check_output(t("You can use basic HTML tags in these boxes."));

  $form3 .= form_textarea(t("Local Partners"),"sponsors",$node->sponsors,40,2,"Enter any local event partners here (optional). Sponsors will listed after the text, \"Local partners:\"");
        
  $form3 .= form_textarea(t("Directions"),"directions",$node->directions,40,2,"What is the best way to find your start location?");
  
  $form3 .= form_textarea(t("Additional Information"),"description",$node->description,40,5,"Use this space to mention any unique information about your event, and logistical details for your participants.");

  $output .= form_group(t("Details"),$form3);

  if (user_access("administer gathering signups")){
    $form4 .= form_select(t("Allow Signups"),"signup_status",$node->signup_status,array(0=>"No",1=>"Yes"));
    $form4 .= form_textfield(t("Signup Padding"),"signup_pad",$node->signup_pad,30,10);
    $output .= form_group("Signup settings",$form4);
  }
  return $output;
}

// implementation of hook_view
function gathering_view(&$node,$teaser=FALSE,$page=FALSE){
  // get alias data
  // (create alias if there isn't one)
  $alias = _gathering_get_alias($node);
      
  // run themeing function here
  $vars = object2array($node);
  $themed = theme("gathering_node",object2array($node));

  $node->teaser = $themed;
  $node->body = $themed;

  if ($page && !$teaser){
    $node->body .= "<em>"._gathering_node_message($node)."</em><br/><br/>";
  }
}

function _gathering_node_message($node,$user=NULL){
  if (is_null($user)){
    global $user;
  }
  
  $role = _gathering_get_user_relationship($node,$user);
  switch ($role){
    case 'owner':
      $out = "You are organizing this event.";
      break;
    case 'attendee':
      $out = "You are attending this event.";
      break;
    case "volunteer";
      $out = "You are volunteering to help with this event.";
      break;
  }
  return t($out);
}

// TODO- write a better generic theme function
function theme_gathering_node($node){
  $countries = _gathering_get_countries();
  $out .= "<div class='node'>";
  $out .= "<h3>".l($node->title,"node/".$node->nid)."</h3>";
  $out .= $node->city.", ".$countries[$node->country];
  $out .= "</div><br/>";
  return $out;
}

function gathering_load($node){
  // get extra node data
  $additions = db_fetch_object(db_query("SELECT * FROM {gathering_node} WHERE nid=%d",$node->nid));
  $countries = _gathering_get_countries();
  $additions->countryname = $countries[$additions->country];
  
  // get signup data
  $count = 1;
  $signups = _gathering_get_signups($node->nid);
  if (!empty($signups)){
    foreach($signups as $s){
      $count += 1;
      $count += $s['guests'];
    }
  }
  $count += $additions->signup_pad;
  $additions->signupcount = $count;
  
  return $additions;
}

// implementation of hook_insert
function gathering_insert($node,$oldnode=NULL){
  $c = _gathering_get_campaign($node);
  
  // set signup defaults

  if (!user_access("administer gathering signups") || empty($node->signup_pad)){
    $node->signup_pad = 0;
  }
  
  // TODO: timezone management?
  $fields = array("nid"           => $node->nid,
                  "camid"         => $c['camid'],
                  "startdate"     => $c['startdate'],
                  "enddate"       => $c['enddate'],
                  "starttime"     => _gathering_time_sql($node->starttime),
                  "endtime"       => _gathering_time_sql($node->endtime),
                  "address1"      => $node->address1,
                  "address2"      => $node->address2,
                  "city"          => $node->city,
                  "state"         => $node->state,
                  "zipcode"       => $node->zipcode,
                  "country"       => $node->country,
                  "sponsors"      => $node->sponsors,
                  "description"   => $node->description,
                  "directions"    => $node->directions,
                  "route"         => $node->route,
                  "signup_pad"    => $node->signup_pad);
  
  if (user_access("administer gathering signups")){
    // user is permissioned to set signup_status, so use submitted value
    $fields['signup_status'] = $node->signup_status; 
  } elseif(is_null($oldnode)){
    // user is not permissioned to set signup_status
    // this is a new node, so use default value
    $fields['signup_status'] = 1;
  } else {
    // node is being updated, so use previous signup_status value
    $fields['signup_status'] = $oldnode->signup_status;
  }

  
  foreach($fields as $var=>$val){
    $sql_vars[] = $var;
    $sql_signs[] = "'%s'";
    $args[] = $val;
  }
  
  $q = "INSERT INTO {gathering_node} (".implode(",",$sql_vars).") VALUES (".implode(",",$sql_signs).")";
  
  array_unshift($args,$q);
  call_user_func_array("db_query",$args);
}

// implementation of hook_update
function gathering_update($node){
  $oldnode = node_load(array("nid"=>$node->nid));
  
  db_query("DELETE FROM {gathering_node} WHERE nid=%d",$node->nid);
  gathering_insert($node,$oldnode);
}

// implementation of hook_delete
function gathering_delete($node){
  db_query("DELETE FROM {gathering_node} WHERE nid=%d",$node->nid);
}

function gathering_nodeapi(&$node, $op, $teaser = NULL, $page = NULL){
  switch ($op){
    case 'subtabs':
      if (node_get_module_name($node) == "gathering"){
        return _gathering_subtabs($node);
      }
      break;
  }
}

// campaign homepage
function gathering_page($op,$camid=NULL){
  switch ($op){
    case "home":
      gathering_page_campaign($camid,arg(3));
      break;
    case "organize":
      gathering_page_organize($camid);
      break;
    case "signup":
      gathering_page_signup($camid);
      break;
    case "message":
      gathering_page_message($camid);
      break;
    case "invite":
      gathering_page_invite($camid);
      break;
    default:
      drupal_not_found();
  }
}

// sends invitations
function gathering_page_invite($nid){
  // collect variables
  $edit = $_POST['edit'];
  global $user;
  global $base_url;
  $node = node_load(array("nid"=>$nid));  
  $countries = _gathering_get_countries();
  $c = _gathering_get_campaign($node);

  // check permissions
  if (!_gathering_user_access("invite",$node)){
    drupal_access_denied();
    $out = false;
  } else {
    // validate
    _gathering_invite_validate($edit);
    if (form_get_errors()){
      // validation failure
      drupal_set_title(t("oops"));
      $out = form(_gathering_invite_form($edit));
    } else {
      // validation success - send
      $recipients = _gathering_invite_parse($edit['recipients']);
      $from = $user->mail;
      $subject = t(variable_get("gathering_invite_subj",""));
      $postmessage = t("Click here for details and to register for this ".$c['name']." event:")."\n".$base_url."/node/".$node->nid;
            
      $text = strip_tags($edit['message']."\n\n".$postmessage);
      $html = check_output($text);
      mailqueue_enqueue($from,$recipients,$subject,$text,$html);
      drupal_set_message(t("Your message has been sent!"));
      drupal_goto("node/".$nid);
      $out = false;
    }
  }

  if ($out){
    print theme("page",$out);
  }
}

// sends GatheringMessages
function gathering_page_message($nid){
  $edit = $_POST['edit'];

  if (!user_access("send and receive GatheringMessages")){
    drupal_set_message(t("There has been an error. (#101)"));
    $send = false;
  } else {
    // get data objects
    global $user;
    $node = node_load(array("nid"=>$nid));
    $countries = _gathering_get_countries();
    global $base_url;
    
    // check relationship
    $rel = _gathering_get_user_relationship($node,$user);
    // switch on sender relationships
    switch ($rel){
      case "owner":
        // switch on recipient relationships
        switch ($edit['recip']){
          case "attendee":
          case "volunteer":
            $to = _gathering_message_get_recips($node,$edit['recip']);
            $postmessage = "This message has been sent to you through FightHunger.org.\n\nYou are walking in the event in ".$node->city.", ".$countries[$node->country]."\n".$base_url."/node/".$node->nid;
            $send = true;
            break;
          default:
            drupal_set_message(t("There has been an error. (#102)"));
            $send = false;
            break;
        }
        break;
      case "attendee":
      case "volunteer":
        // switch on recipient relationships
        switch ($edit['recip']){
          case 'coordinator':
            $to = _gathering_message_get_recips($node,$edit['recip']);
            $postmessage = "This message has been sent to you through FightHunger.org.\n\nYou are organizing the event in ".$node->city.", ".$countries[$node->country]."\n".$base_url."/node/".$node->nid;
            $send = true;
            break;
          default:
            drupal_set_message(t("There has been an error. (#103)"));
            $send = false;
            break;
        }
    }
    
    // should we send
    if ($send){
      // yes- let's send
      $from = $user->mail;
      $text = strip_tags($edit['message']."\n\n".$postmessage);
      $html = check_output($text);
      mailqueue_enqueue($from,$to,$edit['subject'],$text,$html);
      drupal_set_message("Your message has been sent.");
    }
    
  }
  drupal_goto("node/".$nid);
}

function _gathering_message_get_recips($node,$mode){  
  switch($mode){
    case 'attendee':
      $q =  "SELECT u.mail FROM {users} u, {gathering_signup} gs ".
            "WHERE u.uid = gs.uid AND gs.wid = %d";
      break;
    case 'volunteer':
      $q =  "SELECT u.mail FROM {users} u, {gathering_signup} gs ".
            "WHERE u.uid = gs.uid AND gs.wid = %d";
      $q .= " AND gs.role='volunteer'";
      break;
    case 'coordinator':
      $q =  "SELECT u.mail FROM {users} u, {node} n ".
            "WHERE n.uid = u.uid AND n.nid = %d";
      break;
  }
    
  $rs = db_query($q,$node->nid);
  while ($a = db_fetch_array($rs)){
    $out[] = $a['mail'];
  }
  
  return $out;
}


function gathering_page_campaign($camid, $country='') {

  $campaigns = _gathering_get_campaigns();
  $c = $campaigns[$camid];

  if (!isset($c)){
    drupal_not_found();
  } else {
    global $user;
    // fetch civicrm data if it is absent
    if (!isset($user->first_name)){
      $user = user_load(array("uid"=>$user->uid));
    }

    $edit = $_POST['edit'];
    $status = _gathering_user_statusreport($camid,$user);
    $country = isset($edit['c']) ? $edit['c'] : $country;

    // country_search form
    $onchange = 'onchange="submit()"';  
    $form = form_select(t("Country"),"c",$country,_gathering_get_countries(),NULL,$onchange);
    $country_search = form($form);

    // build country_list
    if ($country<>"") {
      $nodes = _gathering_get_nodes_by_country($country,$camid);
      if ($nodes){
        foreach ($nodes as $nid){
          $node= node_load(array("nid"=>$nid));
          $items[] = $node->city.": ".l($node->title,"node/".$node->nid);
        }
        $country_list = theme("form_element","events in your country",theme("item_list",$items));
        $country_msg = t("Don't see an event near you?"). "&nbsp;";
      } else {
        $country_list = t("There are no events scheduled in this country.");
        $country_msg = t("Don't see an event in this country?"). "&nbsp;";
      }
    }

    // country add event
    if (($c['active']) && ($country<>""))  {
      $country_add = '';
      $uri = "gathering/organize/".$camid . ($country ? "?c=$country": "");
      if (!$status) {
        $country_add = $country_msg;
        $p = l(t("Click here to start your own!"), $uri);
        $country_add .= check_output($p);
        $country_add .= theme("gathering_btn_create",$uri);
      } else if (user_access("create multiple gatherings per campaign")) {
        $country_add = $country_msg;
        $p = t("You may also")." ".l(t("create another event!"),$uri);
        $country_add .= check_output($p);
        $country_add .= theme("gathering_btn_create",$uri);
      }
    }

    // user section
    if (empty($status)) {
      $user_section = strtolower("<h4>".t($c['name'].": find a ".$c['eventname']." near you")."</h4>");
      $user_section .= check_output(t($c['description']));
    } else {
      // participant user homepage -- links to events
      $user_section = check_output($status);
      $p = t("Visit your event page to download materials, update your details, and invite others to join you.");
      $user_section .= check_output($p);
    }

    $out .= "<h2>".t("welcome").", ".$user->first_name."</h2>\n";
    $out .= theme("wtw_map",$camid);
    
    if (module_exist("echo_action_transition") && ($c['camid'] == 1)){
      $out .= $user_section;
      $out .= $country_search;
      $out .= $country_list;
      $out .= echo_action_transition_wtw05home();
    } else {
      $out .= $user_section;
      $out .= $country_search;
      $out .= $country_list;
      $out .= $country_add;
    }
    print theme("page",$out);
  }
}

// event signup wizard
function gathering_page_signup($nid){
  $sitename = variable_get("site_name","Drupal");
  $edit = $_POST['edit'];
  
  // is a user logged in?
  global $user;
  if ($user->uid == 0){
    // user is not logged in
    // is the email address entered an already-existing user?
    $user_from_db = user_load(array("mail"=>$edit['mail']));
    if ($user_from_db->uid > 0){
      // yes, user exists already
      // does password match?
      if (md5($edit['pass']) == $user_from_db->pass){
        // yes, password matches
        // log user in
        $user = $user_from_db;
        drupal_set_message(t("You have been logged in."));
        
        // is user permissioned to signup?
        $node = node_load(array("nid"=>$nid));
        if (_gathering_user_access("signup",$node,$user)){
          // yes, user is permissioned
          // create signup record
          _gathering_create_signup($user,$nid,$edit);
          drupal_set_message(t("You are signed up."));
        } else {
          // user is not permissioned, so set message
          drupal_set_message(t("You are not permissioned to sign up for this event."));
        }
          
        // go to node
        drupal_goto("node/".$nid);
      } else {
        // no, password does not match
        // ask for password
        $edit['pass'] = "";
        $edit['pass2'] = "";
        drupal_set_message(t("You have entered an email address that already has a $sitename user account. Log in by entering your password into this form."));
        $out = form(_gathering_signup_form($edit,true));
      }
      
    } else {
      // no, user does not yet exist
      // does user data validate?
      _gathering_user_validate($edit,true);
      
      if (form_get_errors()){
        // data does not validate
        // ask for better data
        $out = form(_gathering_signup_form($edit));
        
      } else {
        // data validates
        // create and log in a new user
        $userdata = _gathering_save_user($edit);

        // create new signup record
        _gathering_create_signup($userdata['user'],$nid,$edit);
        
        // go to node
        drupal_goto("node/".$nid);
      }
    }
  } else {
    // user is logged in
    // is user permissioned to signup?
    $node = node_load(array("nid"=>$nid));
    if (_gathering_user_access("signup",$node,$user)){
      // yes, user is permissioned
      // create signup record
      _gathering_create_signup($user,$nid,$edit);
      drupal_set_message(t("You are signed up."));
    } else {
      // user is not permissioned, so set message
      drupal_set_message(t("You are not permissioned to sign up for this event."));
    }
    $out = false;
    drupal_goto("node/".$node->nid);
  }
  
  if ($out){
    print theme("page",$out);
  }
}

// utility function
// creates signup record
// called by gathering_page_signup()
function _gathering_create_signup($user,$nid,$edit){
  if ($edit['volunteer']){
    $role = "volunteer";
  } else {
    $role = "attendee";
  }
  db_query("INSERT INTO {gathering_signup} SET wid=%d,uid=%d,role='%s',comment='%s',opencomment=%d,timestamp=now(),guests=%d",$nid,$user->uid,$role,$edit['comment'],$edit['opencomment'],$edit['guests']);
}


// event creation wizard
function gathering_page_organize($camid,$edit=NULL){
  if (is_null($edit)){
    $edit = $_POST['edit'];
  }

  $campaigns = _gathering_get_campaigns();
  $c = $campaigns[$camid];
  $sitename = variable_get("site_name","Drupal");
  
  switch ($edit['step']){
    case '':
      // Initial page
      // is a user logged in?
      global $user;
      if ($user->uid > 2){
        // yes
        $nodedummy->type = $c['nodetype'];
        // may they create a new walk?
        if (_gathering_user_access("create",$nodedummy)){
          // yes they may, so continue
        } else {
          // no they may not, so redirect
          drupal_goto("gathering/home/".$camid);
          $stop = true;
        }
      } elseif(!$c['active']){
        // if this is an inactive campaign, go to page-not-found
        drupal_not_found();
        $stop = true;
      } 
      
      if (!$stop){
        // request node data
        
        // create node form
        $form .= gathering_form($null,true);
        $form .= form_hidden("step",1);
        $form .= form_submit("Next Step");
        
        drupal_set_title(t("create your own ".$c['eventname']));
        $out .= check_output(t("Organise a ".$c['name']." ".t("event near you on").date(" j F!",strtotime($c['startdate']))));
        
        if ($user->uid == 0){
          $out .= check_output("<strong>".t("Important").":</strong> ".t("If you already have an account with $sitename").", ".l(t("click here to log in"),"user/login")." ".t("before completing this form!"));
        }
        
        $out .= "<h2>".t("step one: enter your ".$c['eventname']." information")."</h2>";
        $out .= check_output(t("This information will be visible to anyone interested in joining your ".$c['name']));
        $out .= form($form);
      }
      break;
    case '1': 
      // Step Two
      
      // check submitted data for errors
      $edit['type'] = "gathering-".$camid;
      node_validate($edit);
      if (form_get_errors()){
        // there are errors, so ask for corrections
        $form  = form_textfield("Event Name","title",$edit['title'],40,64,"A title for your event.");
        $form .= gathering_form($edit);
        $form .= form_hidden("step",1);
        $form .= form_submit("Next Step");      
        $out .= form($form);
      } else {
        drupal_set_title(t("step two: enter your personal information"));
      
        // there are no errors 
        // is a user logged in?
        global $user;
        if ($user->uid > 1){
          $newedit = $edit;
          $newedit['step'] = 2;
          return gathering_page_organize($camid,$newedit);
          $out = false;
        } else {
          //ask for user data
          $params['country'] = $edit['country'];
          $form = _gathering_user_form($params);
          $edit['step'] = 2;
          foreach($edit as $var=>$val){
            $form .= form_hidden($var,$val);
          }
          $form .= form_submit("Create your event");
          
  // uncomment this line to preview the node here
  //        $out .= node_view($edit,TRUE,TRUE);
          $out .= check_output(t("Enter your personal information here:"));
          $out .= form($form);
        }
      }
      break;
    case '2':
      // Final step
      // are we logged in?
      global $user;
      if ($user->uid > 0){
              // create node
              $nid = _gathering_save_node($edit,$user,$userdata['crm']);
              
              // finish
              drupal_set_message(t("You have created your event!"));
              drupal_goto("node/".$nid);      
      } else {      
        // does a user with this email exist already?
        // does a user with this email exist?
        $user_from_db = user_load(array("mail"=>$edit['mail']));
        if ($user_from_db->uid > 0){
          // yes- so pass this off to a helper function because the logic is about to get complicated
          $out = _gathering_page_organize_preexisting($edit,$user_from_db);
        } else {
          // check user data for errors
          _gathering_user_validate($edit);
          if (form_get_errors()){
            // there are errors- so ask for corrections
            $form .= _gathering_user_form($edit);
            $form .= form_hidden("step",2);
            // TODO add hidden node fields
            $form .= _gathering_page_organize_nodefields($edit);
            $form .= form_submit("Next Step");      
            $out .= form($form);
          } else {
            // no user errors, so re-validate node data
            node_validate($edit);
            if (form_get_errors()){
              // there are node errors-- 
              // this will only happen if someone is hacking, so ignoring for now
              // TODO add appropriate error handling here
            } else {
              // no node errors
              // create user
              $userdata = _gathering_save_user($edit);
              
              // create node
              $nid = _gathering_save_node($edit,$userdata['user'],$userdata['crm']);
              
              // finish
              drupal_set_message(t("You have created your event!"));
              drupal_goto("node/".$nid);
            }
          }
        }
      }
      break;
  }
  
  // this "if" is necessary in case one of the utility functions has called drupal_goto
  if ($out){
    print theme("page",$out);
  }
}

// utility function for gathering_page_organize
// called when a user enters a pre-existing email address in step two
// returns false, otherwise returns page output
function _gathering_page_organize_preexisting($edit,$u){
  $sitename = variable_get("site_name","Drupal");

  // is this user permissioned to create a new gathering?
  $access = _gathering_user_access("create",array2object($edit),$u);
  if ($access){
    // yes, this user may create a new gathering
    // check password
    if (md5($edit['pass']) == $u->pass){
      // password is accurate, log them in
      global $user;
      $user = $u;

      // save new crm data
      $crm = _gathering_save_user_crm($edit);

      // create new node
      $nid = _gathering_save_node($edit,$user,$crm);
            
      // finish
      drupal_set_message(t("You have succesfully logged in to your account."));
      drupal_goto("node/".$nid);
    } else {
      // password check was unsuccesful
      // ask for a password
      drupal_set_message(t("You have entered an email address that already has a $sitename user account. Log in by entering your password into this form."));
      $form .= form_textfield(t("Email"),"mail",$edit['mail'],40,64);
      $form .= form_password(t("Password"),"pass","",40,64);
      $form .= t("Forgot your password? ").l(t("Click here to have it mailed to you."),"user/password")."<br/>";
      $form .= _gathering_page_organize_nodefields($edit);
      $form .= form_hidden("step",2);
      $form .= form_submit("Submit");
      $out = form($form);
    }
  } else {
    // no, this user is forbidden from creating a new gathering
    $c = _gathering_get_campaign(array2object($edit));
    drupal_set_message(t("The email address you entered is already a member of ".$sitename.". Please log in."));
/*
    $form  = form_textfield(t("Email"),"mail",$edit['mail'],40,64);
    $form .= form_password(t("Password"),"pass","",40,64);
      $form .= t("Forgot your password? ").l(t("Click here to have it mailed to you."),"user/password")."<br/>";
    $form .= form_submit("Submit");
    $out = form($form,"POST","user/login");*/
    $out = user_login(array("name"=>$edit['mail']));
    $out .= t("Forgot your password? ").l(t("Click here to have it mailed to you."),"user/password")."<br/>";
    
  }
  
  return $out;
}

// utility function for gathering_page_organize
// creates hidden form elements to propagate node data across steps
function _gathering_page_organize_nodefields($edit){
  $fields = array("nid",           
                  "type",
                  "startdate",
                  "enddate",       
                  "starttime",     
                  "endtime",       
                  "address1",      
                  "address2",      
                  "city",          
                  "state",         
                  "zipcode",       
                  "country",       
                  "description",
                  "directions",  
                  "route"
                  );
  foreach ($fields as $f){
    $out .= form_hidden($f,$edit[$f]);
  }
  return $out;
}

function theme_gathering_btn_create($uri){
  return l("Create your own event",$uri);
}

// builds campaign admin page
function gathering_admin(){
  // get all active campaigns
  $campaigns = _gathering_get_campaigns();
  switch(arg(2)){
    case "edit":
      $edit = $_POST['edit'];
      $fields = array("eventname","description","shortname","startdate","active");
      if ($edit['op'] == "save"){
        foreach ($fields as $f){
          $sql_sets[] = $f."='%s'";
          $args[] = $edit[$f];
        }
        $q = "UPDATE {gathering_campaign} SET ".implode(",",$sql_sets)." WHERE camid=%d";        
        $args[] = arg(3);
        
        array_unshift($args,$q);
        call_user_func_array("db_query",$args);
        drupal_set_message("The campaign has been edited.");
        drupal_goto("admin/gathering");
      } elseif ($edit['op'] == "add"){
        foreach ($fields as $f){
          $sql_sets[] = $f."='%s'";
          $args[] = $edit[$f];
        }
        $q = "INSERT INTO {gathering_campaign} SET ".implode(",",$sql_sets);
        
        array_unshift($args,$q);
        call_user_func_array("db_query",$args);
        drupal_set_message("The campaign has been created.");
        drupal_goto("admin/gathering");
      } else {
        $out .= form(gathering_admin_campaignform($campaigns[arg(3)],"save"));
      }
      break;
//    TODO:
//    case "delete":
    default:
      $fields = array("eventname","description","shortname","startdate","active");
    
      foreach ($campaigns as $c){
        $out .= "<h3>Campaign #".$c['camid'].": ".$c['name']."</h3>";
        foreach ($fields as $var){
          $out .= theme("form_element",$var,$c[$var]);
        }
        $out .= l("Edit","admin/gathering/edit/".$c['camid']);
    //      $out .= l("Delete","admin/gathering/delete/".$c['camid']);
        $out .= "<hr/>\n";
      }
    
      $out .= "<h3>Create a New Campaign</h3>";
      $out .= gathering_admin_campaignform(NULL,"add");
      break;
  }
  
  print theme("page",$out);
}

function gathering_admin_campaignform($data=array(),$op){
  $out .= form_textfield("Name","name",$data['name'],40,64);
  $out .= form_textfield("Event Name","eventname",$data['eventname'],40,64,"A one-word noun describing the type of events in this campaign. (e.g. 'walk' or 'concert')");
  $out .= form_textfield("Short Name","shortname",$data['shortname'],40,64,"A one-word noun (e.g. 'wtw06') used for aliasing campaign and events (e.g. 'wtw06/london').");
  $out .= form_textarea("Description","description",$data['description'],50,3,"This text appears beneath the map on the campaign homepage.");
  $out .= form_textfield("Date","startdate",$data["startdate"],40,10,"Use the format YYYY-MM-DD");
  
  $out .= form_select("Active","active",$data["active"],array(0=>"Inactive",1=>"Active"),"Set to 'inactive' to close this campaign and prophibit new events from being added.");
  
  
  $out .= form_hidden("op",$op);
  $out .= form_submit($op);
  
  return form($out,"POST","admin/gathering/edit");
}

// utility function for hook_menu
function _gathering_menu_campaign(){
  // get all active campaigns
  $campaigns = _gathering_get_campaigns();
  
  foreach ($campaigns as $c){
    $node->type = $c['nodetype'];
    // node creation paths
    $out[] = array(
      'title'       => t($c['eventname']) ." - ". t($c['name']),
      'path'        => 'node/add/'.$c['nodetype'],
      // TODO fix this user_access call with new permissions
      'access'      => user_access("administer gathering campaigns")
    );
    
    
    // campaign home paths
    if (!empty($c['shortname'])){
      $out[] = array(
        'title'               => t($c['name']),
        'path'                => $c['shortname'],
        'access'             => true,
        'type'                => MENU_CALLBACK,
        'callback'            => "gathering_page_campaign",
        'callback arguments'  => array($c['camid'])
      );
    }
    
  }

  return $out;
}

// utility function to fetch gathering campaigns
function _gathering_get_campaigns(){
  static $campaigns;
  
  if (!$campaigns){
    $rs = db_query("SELECT * FROM {gathering_campaign} ORDER BY startdate ASC");
    while ($c = db_fetch_array($rs)){
      $campaigns[$c['camid']] = $c;
      $campaigns[$c['camid']]['nodetype'] = "gathering-".$c['camid'];
    }
  }
  
  return $campaigns;
}

// fetch a list of all available countries, indexed by two-letter ISO codes
function _gathering_get_countries(){
  static $countries;
  if (empty($countries)){
    $rs = db_query("SELECT * FROM {countries} ORDER BY name ASC");
    while ($c = db_fetch_array($rs)){
      $countries[$c['ccid']] = ucwords(strtolower($c['name']));
    }
    $s = array("--"=>"(choose your home country)");
    $countries = array_merge($s,$countries);
  }
  return $countries;
}

// utility function fetches campaign data for a node
function _gathering_get_campaign($node){
  $camid = _gathering_get_camid($node->type);
  $campaigns = _gathering_get_campaigns();
  return $campaigns[$camid];
}

// utility function parses campaign-id from node-type
function _gathering_get_camid($type){
  return substr($type,10);
}

// subtabs.module API function
// called through gathering_nodeapi
function _gathering_subtabs($node){
  $rel = _gathering_get_user_relationship($node);
  switch ($rel){
    case "owner":
      $out[] = array( 
        "title"     => t("invite"),
        "content"   => _gathering_subtab_invite($node,$rel),
        "access"    => _gathering_user_access("invite",$node),
        "weight"    => -5
      );
      $out[] = array( 
        "title"     => t("contact participants"),
        "content"   => _gathering_subtab_messages($node,$rel),
        "access"    => _gathering_user_access("message",$node),
        "weight"    => 0
      );
      $out[] = array(
        "title"     => t("edit"),
        "content"   => _gathering_subtab_edit($node),
        "access"    => _gathering_user_access("update",$node),
        "weight"    => 10
      );
      break;
    case "attendee":
    case "volunteer":
      $out[] = array( 
        "title"     => t("invite"),
        "content"   => _gathering_subtab_invite($node,$rel),
        "access"    => _gathering_user_access("invite",$node),
        "weight"    => -5
      );
      $out[] = array( 
        "title"     => t("contact organizer"),
        "content"   => _gathering_subtab_messages($node,$rel),
        "access"    => _gathering_user_access("message",$node),
        "weight"    => 0
      );
      break;
    default:
      $out[] = array(
        "title"     => t("signup"),
        "content"   => _gathering_subtab_signup($node),
        "access"    => _gathering_user_access("signup",$node),
        "weight"    => -10
      );
      break;
  }
  
  $details = _gathering_subtab_details($node);
  $out[] = array(
    "title"     => t("details"),
    "content"   => $details,
    // hide if details is empty
    "access"    => !empty($details),
    "weight"    => 8
  );
  
  return $out;
}

// return a user's relationship to a node
// result will probably be "owner","attendee","volunteer", or NULL
// if no $user is passed, this function will use the currently logged-in user
function _gathering_get_user_relationship($node,$user=NULL){
  static $relationships;

  if (is_null($user)){
    global $user;
  }
  
  if (!isset($relationships[$user->uid][$node->nid])){
    if ($node->uid == $user->uid){
      $relationships[$user->uid][$node->nid] = "owner";
    } else {
      $s = db_fetch_array(db_query("SELECT * FROM {gathering_signup} WHERE uid=%d AND wid=%d",$user->uid,$node->nid));
      $relationships[$user->uid][$node->nid] = $s['role'];
    }
  }
  
  return $relationships[$user->uid][$node->nid];
}


// utility for gathering_subtabs()
function _gathering_subtab_invite($node){
  $formvals['message'] = t(variable_get("gathering_invite_message",""));
  
  $out = "<h3>".t("Invite others to walk with you")."</h3>";
  $out .= form(_gathering_invite_form($formvals),"POST","gathering/invite/".$node->nid); 
  
  return $out;
}

function _gathering_invite_form($data){
  global $user;
  $out .= theme("form_element",t("Your First Name"),$user->first_name);
  $out .= theme("form_element",t("Your Last Name/Surname"),$user->last_name);
  $out .= theme("form_element",t("Your email address"),$user->mail);
  $out .= theme("form_element",t("Subject"),t(variable_get("gathering_invite_subj","")));
  
  $out .= form_textarea(t("recipients"),"recipients",$data['recipients'],30,4,t("Enter as many email addresses as you like, one per line."));
  
  $out .= form_textarea(t("message"),"message",$data['message'],30,8);
  
  $out .= theme("gathering_btn_sendinvites");
  
  return $out;
}

// validate submitted invite form data
// return recipient array if no errors
function _gathering_invite_validate($data){
  if (empty($data['message'])){
    form_set_error("message",t("Please enter a message."));
    $out = false;
  }

  if ($data['recipients']) {
    $recipients = _gathering_invite_parse($data['recipients']);
    foreach ($recipients as $email) {
      if (!valid_email_address($email)) {
        form_set_error('recipients', t('There is a problem with this address: ').$email);
      }
    }
  } else {
    form_set_error('recipients', t('Please enter your recipients.'));
  }

  return $out;
}

// utility function for parsing invite recipients from user input
function _gathering_invite_parse($recips){
  static $parsed;
  
  if (empty($parsed)){
    $parsed = preg_split("/[\s,;]+/", $recips);
  } 
  
  return $parsed;
}

function theme_gathering_btn_sendinvites(){
  return form_submit(t("Send Invites"));
}

// utility for gathering_subtabs()
// must return empty (ie, no title) if there is no content 
function _gathering_subtab_details($node){
  if (!empty($node->directions)){
    $out .= theme("form_element","directions",$node->directions);
  }
  
  if (!empty($node->description)){
    $out .= theme("form_element","additional info",$node->description);
  }

  if (!empty($out)){
    $out = "<h3>Event Details</h3>".$out;
  }
  
  global $user;
  if (($user->uid == $node->uid) || user_access("administer gathering signups")){
    $out .= _gathering_subtab_details_signups($node);
  }
  
  return $out;
}

function _gathering_subtab_details_signups($node){
  $head = array(
    t("First Name"),
    t("Last Name"),
    t("Email"),
    t("Phone"),
    t("Role")
  );

  $signups = _gathering_get_signups($node->nid);
  foreach ($signups as $s){
    $u = user_load(array("uid"=>$s['uid']));

    $rows[] = array(
      $u->first_name,
      $u->last_name,
      "<a mailto='".$u->mail."'>".$u->mail."</a>",
      $u->phone,
      $s['role']
    );
  }
  
  $out = "<h3>".t("Attending This Event")."</h3>";
  $out .= theme("table",$head,$rows);
  
  return $out;
}


function _gathering_subtab_messages($node){
  global $user;
  $rel = _gathering_get_user_relationship($node,$user);
  
  switch ($rel){
    case "owner":
      $out = "<h3>".t("Send messages to attendees")."</h3>";
      $count = _gathering_count_attendance_by_role($node);
      if ($count['total'] > 0){
        $options["attendee"] = t("Send to all users attending this event.")." (".$count['total']." ".(($count['total'] > 1) ? t("recipients") : t("recipient")).")";
      }
      if ($count['volunteer'] > 0){
        $options["volunteer"] = t("Send only to the users who have volunteered to help with this event.")." (".$count['volunteer']." ".(($count['attendee'] > 1) ? t("recipients") : t("recipient")).")";
      }
      if (empty($options)){     
        $out .= check_output(t("No one has signed up for this event yet. You can use this page to contact attendees and volunteers when they have signed up."));
        $donotsend = true;
      } else {
        $form = form_radios("Send To","recip","attendee",$options);
      }
      break;    
    case "attendee":
    case "volunteer":
      $out = "<h3>".t("Send a message to the event coordinator")."</h3>";
      $form = form_hidden("recip","coordinator");
      break;
  }
  
  $form .= form_textfield("Subject","subject","",40,64);
  $form .= form_textarea("Message","message","",30,8);
  $form .= form_submit(t("Send"));
  
  if (!$donotsend){
    $out .= form($form,"POST","gathering/message/".$node->nid);
  }
  return $out;
}

function _gathering_subtab_signup($node){
  $form = _gathering_signup_form();

  $out  = "<h3>".t("Walk with us!")."</h3>";
  $out .= form($form,"POST","gathering/signup/".$node->nid);
  return $out;
}

function _gathering_signup_form($data=array(),$loggingin=false){

  global $user;
  if ($user->uid == 0){
    if (!$loggingin){
      // add javascript login links
      $out = _gathering_signup_form_js();
    }  
    $form = _gathering_user_form($data,true,$loggingin);
  } else {
    $form .= form_group("Login Information",theme("form_element","EMail",$user->mail));
  }
  
  $out .= $form;

  $sform .= form_textfield(t("My guests"),"guests",$data['guests'],5,5,"I am bringing this many others to walk with me.");
  
  $sform .= form_textarea(t("Comment (optional)"),"comment",$data['comment'],40,5,"Feel free to leave a comment for the other attendees.");
  $sform .= form_checkbox(t("Show my comment in the attendee list."),"opencomment",1,$data['opencomment'])."<br/>";

  $sform .= form_checkbox(t("I would like to volunteer to help organize this event."),"volunteer",1,$data['volunteer']);
  

  $out .= theme("form_group","Signup Information",$sform,array("id"=>"form_signup"));
  $out .= theme("gathering_btn_walk");
  
  return $out;
}

function _gathering_signup_form_js(){
  $out  = "<p id='p_login'>";
  $out .= t("Already have an account?")." ";
  $out .= "<span class='link' onClick='signup_hide();'>".t("Click here to log in.")."</span>";
  $out .= "</p>";

  $out .= "<p id='p_create'>";
  $out .= t("Don't have an account?")." ";
  $out .= "<span class='link' onClick='signup_show();'>".t("Click here to create one.")."</span>";
  $out .= "</p>";

  $js ="<script type='text/javascript'>
function signup_hide(){
  document.getElementById('pass2').style.display = 'none';
  document.getElementById('form_contact').style.display = 'none';

  document.getElementById('p_login').style.display = 'none';
  document.getElementById('p_create').style.display = 'block';
}
function signup_show(){
  document.getElementById('pass2').style.display = 'block';
  document.getElementById('form_contact').style.display = 'block';

  document.getElementById('p_login').style.display = 'block';
  document.getElementById('p_create').style.display = 'none';
}
</script>";
  $styles = "<style>
.link {
  cursor: pointer;
  text-decoration: underline;    
}
#p_create {
  display: none;
}
</style>";
  drupal_set_html_head($js);
  drupal_set_html_head($styles);

  return $out;
}

function theme_gathering_btn_walk(){
  return form_submit(t("Walk"));
}

function _gathering_subtab_edit($node){
  $c = _gathering_get_campaign($node);
  $out .= "<h3>Edit this ".$c['eventname']."</h3>";
  $out .= node_form($node);
  return $out;
}

// returns a form of user and civicrm fields
function _gathering_user_form($vals=array(),$signup=false,$loggingin=false){

  // email
  $form1 .= form_textfield(t("EMail"),"mail",$vals['mail'],40,64,"",NULL,TRUE);
  
  $form1 .= form_password(t("Password"),"pass",$vals['pass'],40,64,"",NULL,TRUE);
  if (!$loggingin){
    $form1 .= "<div id='pass2'>";
    $form1 .= form_password(t("Password (repeat)"),"pass2",$vals['pass2'],40,64,t("Enter your password a second time."),NULL,TRUE);
    $form1 .= "</div>";
  }
  
  $out .= theme("form_group",t("Login Information"),$form1,array("id"=>"form_login"));

  if (!$loggingin){
    // first_name
    $form2 .= form_textfield(t("First Name"),"first_name",$vals['first_name'],40,64,"",NULL,TRUE);
    
    // last_name
    $form2 .= form_textfield(t("Last Name / Surname"),"last_name",$vals['last_name'],40,64,"",NULL,TRUE);
  
    // phone
    // (only required for organizing, not signups
    $form2 .= form_textfield(t("Phone number"),"phone",$vals['phone'],40,64,"",NULL,!$signup);
  
    if (!$signup){
      // street address
      $form2 .= form_textfield(t("Street Address"),"street_address",$vals['street_address'],40,64,"",NULL,FALSE);
    
      // city
      $form2 .= form_textfield(t("City"),"city",$vals['city'],40,64,"",NULL,FALSE);
    
      // state_province
      $form2 .= form_textfield(t("State / Province"),"state_province",$vals['state_province'],40,64,"",NULL,FALSE);
    
      // postal_code
      $form2 .= form_textfield(t("Postal Code"),"postal_code",$vals['postal_code'],10,64,"",NULL,FALSE);
    
      // country
      $form2 .= form_select(t("Country"),"country",$vals['country'],_gathering_get_countries(),NULL,NULL,NULL,FALSE);
    }
  }
  
  if ($form2){
    $out .= theme("form_group",t("Contact Information"),$form2,array("id"=>"form_contact"));
  }

  return $out;
}

// validates user fields
// TODO: should this be moved to hook_user somehow?
function _gathering_user_validate($data,$signup=false){
  // check email
  if ($error = user_validate_mail($data['mail'])){
    form_set_error('mail',$error);
  }

  // build required fields
  $required_fields[] = array(
    'name' => "Password 1",
    'variable'     => "pass"
  );
  $required_fields[] = array(
    'name' => "Password 2",
    'variable'     => "pass2"
  );
  $required_fields[] = array(
    'name' => "First Name",
    'variable'     => "first_name"
  );
  $required_fields[] = array(
    'name' => "Last Name / Surname",
    'variable'     => "last_name"
  );
  if (!$signup){
    $required_fields[] = array(
      'name' => "Phone Number",
      'variable'     => "phone"
    );
  }
  
  foreach ($required_fields as $f){
    $v = $f['variable'];
    if (isset($data[$v]) && (empty($data[$v]))){
      form_set_error($v,t("Please enter a ".$f['name']."."));
    }
  }
  
  // validate country field
  if ($data['country'] == "--"){
    form_set_error("country",t("Please select a Country."));
  }
  
  // check password
  if (($data['pass'] != $data['pass2']) && (isset($data['pass']) && !empty($data['pass'])) && (isset($data['pass2']) && !empty($data['pass2']))){
    form_set_error("pass",t("Your passwords must match."));  
  }
  
}

// utility function saves a user from submitted data
function _gathering_save_user($edit){
  $user_to_save = array(  'name'    => $edit['mail'], 
                          'init'    => $edit['mail'], 
                          'mail'    => $edit['mail'], 
                          'roles'   => array(2),
                          'status'  => 1,
                          'pass'    => $edit['pass']
                          );
  $new_user = user_save('', $user_to_save);
  
  // login user
  global $user;
  $user = $new_user;

  // save CRM data
  $c = _gathering_save_user_crm($edit);
  
  return array('user' => $user,
               'crm'  => $c);
}

function _gathering_save_user_crm($edit){
  if (module_exist('civicrm')) {
    // get contact object
    civicrm_initialize(TRUE);
    $param['email'] = $edit['mail'];
    $c = crm_get_contact($param);

    // update contact object
    $crm_data = array('first_name'      => $edit['first_name'],
                      'last_name'       => $edit['last_name'],
                      'phone'           => $edit['phone'],
                      'street_address'  => $edit['street_address'],
                      'city'            => $edit['city'],
                      'state_province'  => $edit['state_province'],
                      'postal_code'     => $edit['postal_code'],
                      'country'         => $edit['country']);
    crm_update_contact($c,$crm_data);
  } else {
    $c = NULL;
  }

  return $c;
}

// utility function for gathering_page_organize
// parses posted data into a new node
// saves civicrm data if crm data is passed
function _gathering_save_node($edit,$user,$crm=NULL){
  $edit['uid'] = $user->uid;
  // save node
  $nid = node_save(array2object($edit));
  
  if (is_null($crm) && module_exist('civicrm')){
    // try to find the crm if it hasn't been passed
    civicrm_initialize(TRUE);
    $param['email'] = $user->mail;
    $crm = crm_get_contact($param);
  }
  
  // now try to add the contact record
  if (module_exist('civicrm') && !is_null($crm)){
    $campaigns = _gathering_get_campaigns();
    $camp = $campaigns[arg(2)];
    
    // save crm action
    $action = array('entity_id'         => $crm->id,
                    'entity_table'      => 'civicrm_contact',
                    'activity_date'     => date("YmdHis"),
                    
// activity_type: 
//  sortable label for this activity assigned be registering module or user (e.g. Phone Call)
                    'activity_type'     => 'gathering',
// module:
// Display name of module which registered this activity
                    'module'            => 'gathering',
// callback|method
// function to call which will return URL for viewing details
                    'callback|method'   => 'gathering_civicrm_action_callback',                                 
// activity_id
// FK to details item - passed to callback
                    'activity_id'       => $nid,
// activity_summary
// brief description of activity for summary display - as populated by registering module
                    'activity_summary'  => 'created a '.$camp['eventname'].' ('.$camp['name'].')',
                    );
    $activity = crm_create_activity_history($action);                
  }
  
  // return new node id
  return $nid;
}

function gathering_civicrm_action_callback($nid){
  drupal_goto("node/".$nid);
}

// utility function- used by gathering_access and others
// $op can be "create","delete","update","insert" or "signup"
function _gathering_user_access($op,$node,$user=NULL){
  if (is_null($user)){
    global $user;
  }


  $c = _gathering_get_campaign($node);
  switch ($op){
    case "create":
      if ($c['active'] = false){
        // nobody can create a gathering for an inactive campaign
        $out = false;
      } elseif (user_access("create multiple gatherings per campaign",$user)){
        // users with this permission can always create a new gathering for an active campaign
        $out = true;
      } else {
        // check whether this user is already attending or organizing and event
        $nodes = _gathering_get_user_nodes($user->uid,$c['camid']);
        if ($nodes){
          $out = false;
        } else {
          // these users can create an event only if they have the "create gatherings" permission
          $out = user_access("create gatherings",$user);
          break;
        }
      }
      break;
    case "delete":
      // only admins can delete gatherings
      $out = user_access("administer nodes",$user);
      break;
    case "update":
      if (user_access("administer nodes",$user)){
        // users with "administer nodes" can edit any gathering
        $out = true;
      } elseif (($node->uid == $user->uid) && user_access("edit own gatherings",$user)){
        // users with "edit own gatherings" can edit gatherings they own only for campaigns that are active
        $out = $c['active'];
      } else {
        // nobody else can edit a gathering
        $out = false;
      }
      break;
    case "view":
      // everyone can view gatherings
      $out = true;
      break;
    case "signup":
      if ($c['active'] && $node->signup_status){
        if ($user->uid == 0){
          // anonymous can always signup for active campaigns
          $out = true;
        } else {
          // what gatherings in this campaign is this user associated with ?
          $gatherings = _gathering_get_user_nodes($user->uid,$c['camid']);
          
          // the user must be associated with no gatherings
          $out = (!$gatherings);
        }
      } else {
        //nobody can sign up for inactive campaigns
        //nobody can sign up for events with closed signups
        $out = false;
      }
      break;
    case "message":
      if (user_access("send and receive GatheringMessages")){
        $role = _gathering_get_user_relationship($node,$user);
        $out = !is_null($role);
      } else {
        // user is not permissioned
        $out = false;
      }
      break;
    case "invite":
      $role = _gathering_get_user_relationship($node,$user);
      $out = !is_null($role);
      break;
  }
  return $out;
}

// what nodes does this user attend / organize
function _gathering_get_user_nodes($uid,$camid=NULL){
  // fetch owned
  $q1 = "SELECT n.nid FROM {node} n, {gathering_node} gn WHERE n.type LIKE 'gathering-%%' AND n.uid=%d";
  $args[] = $uid;
  if ($camid){
    $q1 .= " AND n.nid = gn.nid AND gn.camid = %d";
    $args[] = $camid;
  }
  array_unshift($args,$q1);
  $rs1 = call_user_func_array("db_query",$args);
  while ($a = db_fetch_array($rs1)){
    $out['owner'][] = $a['nid'];
  }
  
  // fetch signups
  unset($args);
  $q2 = "SELECT gs.wid FROM {gathering_signup} gs, {gathering_node} gn WHERE gs.uid=%d AND gs.wid=gn.nid";
  $args[] = $uid;
  if ($camid) {
    $q2 .= " AND gn.camid = %d";
    $args[] = $camid;
  }
  $q2 .= " ORDER BY gs.timestamp DESC";
  array_unshift($args,$q2);
  $rs2 = call_user_func_array("db_query",$args);
  while ($a = db_fetch_array($rs2)){
    $out['attendee'][] = $a['wid'];
  }
  
  return $out;
}

// utility- returns an array of all signup objects for a given node
function _gathering_get_signups($nid){
  static $actions_signups;
  $signups = array();
  if (empty($action_signups[$nid])){
    $rs = db_query("SELECT * FROM {gathering_signup} WHERE wid=%d ORDER BY timestamp DESC",$nid);
    while ($s = db_fetch_array($rs)){
      $signups[] = $s;
    }
    $action_signups[$nid] = $signups;
  }
  
  return $action_signups[$nid];
}

Function _gathering_count_attendance_by_role($node){
  $rs = db_query("SELECT role,count(*) as count FROM {gathering_signup} WHERE wid=%d GROUP BY role",$node->nid);
  while ($a = db_fetch_array($rs)){
    $out[$a['role']] = $a['count'];
  }
  // count total
  foreach ($out as $role=>$c){
    $total += $c;
  }
  $out['total'] = $total;
  return $out;
}

function _gathering_format_title($node,$nocountry=false){
  // TODO make this themeable
  if (is_numeric($node)){
    $node = node_load(array("nid"=>$node));
  }
  
  $cs = _gathering_get_countries();
  $out = "<strong>".l($node->title,"node/".$node->nid) . " ".t("in")." ".$node->city;
  if (!$nocountry){
    $out .= ", ".$cs[$node->country];
  }
  $out .= "</strong>";
  return $out;
}

function _gathering_user_statusreport($camid,$user=NULL){
  if (is_null($user)){
    global $user;
    $thisuser = $user;
    $phrase = t("You are")." ";
  } else {
    $thisuser = $user;
    global $user;
    if ($thisuser->uid == $user->uid){
      $phrase = t("You are")." ";
    } else {
      $phrase = t("This user is")." ";
    }
  }
  
  if ($user->uid > 0){
    $nodes = _gathering_get_user_nodes($thisuser->uid,$camid);
  }
  
  if ($nodes['owner']){
    foreach ($nodes['owner'] as $nid){
      $node = node_load(array("nid"=>$nid));
      $items[] = $phrase.t("organizing")." "._gathering_format_title($node);
    }
  }
  if ($nodes['attendee']){
    foreach ($nodes['attendee'] as $nid){
      $node = node_load(array("nid"=>$nid));
      $items[] = $phrase.t("walking in ")." "._gathering_format_title($node);
    }
  }
  
  if ($items){
    $out = theme("item_list",$items);
  } else {
    $out = "";
  }
  
  return $out;
}

// fetches all gathering nids in a certain country
function _gathering_get_nodes_by_country($c,$camid=NULL){
  $q = "SELECT nid FROM {gathering_node} WHERE country='%s'";
  $args[] = $c;
  if (!is_null($camid)){
    $q .= " AND camid=%d";
    $args[] = $camid;
  }
  $q .= " ORDER BY city";
  
  array_unshift($args,$q);
  $rs = call_user_func_array("db_query",$args);
  while ($a = db_fetch_array($rs)){
    $out[] = $a['nid'];
  }
  return $out;
}

// adds id attributes to form_group calls
// (this is native in 4.7, but a hack for our 4.6)
function theme_form_group($title,$content,$atts){
  $out = "<div".drupal_attributes($atts).">".form_group($title,$content)."</div>";
  return $out;
}

// format SQL time into human-readable time
function _gathering_time_display($in){
  if (empty($in)){
    $out = "";
  } else {
    $out = date("g:i A",strtotime($in));
  }
  return $out;
}

// format human-written time into SQL time
function _gathering_time_sql($in=NULL){
  
  $out = date("YmdHis",strtotime($in));
  return $out;
}

// fetch or create a URL alias for this node
function _gathering_get_alias($node){
  // check if there is already an alias
  $alias = db_result(db_query("SELECT dst FROM {url_alias} WHERE src='node/%d'",$node->nid));
  
  if ($alias){
    $out = $alias;
  } else {
    // create a new alias
    $alias = _gathering_get_alias_newname($node);
  }
  
  return $out;
}

// iterative function to find a new url_alias for a gathering node
function _gathering_get_alias_newname($node,$i=1){
  $c = _gathering_get_campaign($node);
  if (empty($c['shortname'])){
    $pre = "";
  } else {
    $pre = $c['shortname'].'/';
  }

  // switch on iteration
  switch ($i){
    case '1':
      // first iteration, try city
      $alias = $pre._gathering_get_alias_clean($node->city);
      break;
    default:
      // other iterations, use city and number
      $alias = $pre._gathering_get_alias_clean($node->city).$i;
      break;
  }
  
  // is this value ok?
  if (_gathering_get_alias_newname_validate($alias)){
    // it is ok, so save it and return it
    db_query("INSERT INTO {url_alias} SET src='%s',dst='%s'","node/".$node->nid,$alias);
    $out = $alias;
  } elseif ($i == 10) {
    // give up after 10 tries
    // (hopefully we will never have 10 events in the same city)
    $out = false;
  } else {
    // try another name
    $out = _gathering_get_alias_newname($node,$i+1);
  }
  
  return $out;
}

// clean a city or country field into a nice human-readable potential uri
function _gathering_get_alias_clean($in){
  // lowercase only
  $in = strtolower($in);
  
  // remove all non-alphabetic characters
  for($c=0; $c<strlen($in); $c++){
    $char = substr($in,$c,1);
    $ascii = ord($char);
    $alphabetic = (($ascii > 96) && ($ascii < 123));
    if ($alphabetic){
      $out .= $char;
    } elseif ($char == " "){
      $out .= "_";
    } elseif ($char == "/"){
      $out .= "/";
    }
  }
  
  return $out;
}

// check whether this alias is already used
function _gathering_get_alias_newname_validate($alias){
  $out = true;
  
  // does it already exist?
  $x = db_fetch_array(db_query("SELECT * FROM {url_alias} WHERE dst='%s'",$alias));
  if ($x){
    $out = false;
  }

  // is it empty?
  if (empty($alias)){
    $out = false;
  }
  
  return $out;
}

function gathering_reports($op=NULL){
  $campaigns = _gathering_get_campaigns();
  if (is_null($op)){
    foreach ($campaigns as $c){
      $items[] = l($c['name'],"admin/gathering_reports/".$c['camid']);
    }
    $camps .= "<h3>Choose a campaign:</h3>";
    $camps .= theme("item_list",$items);
    $out .= form_group("Event Reports",$camps);
    
    $out .= gathering_report_usersearch();
  } elseif ($op == "users"){
    $out = gathering_report_usersearch();
  } else {
    drupal_set_title("reports - ".$campaigns[$op]['name']);
    $out = gathering_report_campaign($op);
  }
  
  print theme("page",$out);
}

function gathering_report_usersearch(){
  $edit = $_POST['edit'];
  
  if (!is_null($edit)){
    // search user table
    $uid = db_result(db_query("SELECT uid FROM users WHERE mail='%s'",$edit['email']));    
    if ($uid){
      $u = user_load(array("uid"=>$uid));
      $uf .= theme("form_element","Email",$u->mail);
//      $uf .= theme("form_element","First Name",$u->first_name);
//      $uf .= theme("form_element","Last Name",$u->last_name);
//      $uf .= theme("form_element","Phone",$u->phone);

      $links = l("Drupal Profile","user/".$u->uid);
      civicrm_initialize(TRUE);
      $param['email'] = $user->mail;
      $c = crm_get_contact($param);
      if ($c){
        $links .= "<br/>".l("CiviCRM Profile","civicrm/contact/view","cid=861");
      }
      
      $uf .= theme("form_element","Links",$links);
      
      $campaigns = _gathering_get_campaigns();
      foreach($campaigns as $c){
        $status = _gathering_user_statusreport($c['camid'],$u);
        if (!empty($status)){
          $uf .= theme("form_element",t($c['name']),$status);
        }
      } 
      
      $out .= form_group(t("Search Result"),$uf);
    }
  }

  $form1 .= form_textfield("Email Address","email",$edit['email'],20,25,"Enter an email address.");
  $form1 .= form_hidden("op","keyword");
  $form1 .= form_submit("Search");
  $form .= form_group("Find Users",$form1);
  $out .= form($form,"POST","admin/gathering_reports/users");

  return $out;
}

function gathering_report_campaign($camid){
  $edit = $_POST['edit'];
  
  if (is_null($edit)){    
    $form1 .= form_textfield("Keywords","keywords","",20,25,"Enter keywords seperated by commas.");
    $form1 .= form_hidden("op","keyword");
    $form1 .= form_submit("Search");
    $form .= form_group("Events- Keyword Search",$form1);
    $out = form($form);
    
    $out .= gathering_report_campaign_lists($camid);
    $out .= gathering_report_campaign_email($camid);
    
  } else {
    switch($edit['op']){
      case 'keyword':
        $out = gathering_report_campaign_search($camid,$edit);
        break;
    }
  }
  
  
  return $out;
}

function gathering_report_campaign_search($camid,$edit){
  drupal_set_title(drupal_get_title()." - search results: '".$edit['keywords']."'");

  $keys = explode(",",$edit['keywords']);
  $q = "SELECT * FROM {node} n, gathering_node {gn} WHERE n.nid = gn.nid AND ";
  $fields = array("n.title","gn.city","gn.description","gn.directions","gn.route","gn.sponsors");
  foreach($keys as $k){
    $k_sql = mysql_escape_string($k);
    unset($qsub);
    foreach($fields as $f){
      $qsub[] = $f." LIKE '%".$k_sql."%'";
    }
    $qs[] = "(".implode(" OR ",$qsub).")";
  }
  $q .= implode(" AND ",$qs)." ORDER BY n.nid ASC";
  
  $rs = db_query($q);
  while ($o = db_fetch_object($rs)){
    $nodes[] = $o;
  }
  
  $out = gathering_report_list($nodes);
  
  return $out;
}

function gathering_report_list($nodes){
  $countries = _gathering_get_countries();
  $header = array("ID","City","Country","Coordinator","Walkers","Created");
  foreach ($nodes as $n){
    if (!isset($n->signups)){
      $n->signups = count(_gathering_get_signups($n->nid));
    }
    
    $u = user_load(array("uid"=>$n->uid));
    $rows[] = array(
      l($n->nid,"node/".$n->nid),
      $n->city,
      $countries[$n->country],
      l($u->mail,"user/".$u->uid),
      $n->signups,
      format_date($n->created,"small")
    );
  }
  
  drupal_set_html_head("
  <style>
  table td {
    padding-right: 20px;
  }
  </style>
  ");
  $out = theme("table",$header,$rows);
  
  return $out;
}

function gathering_report_campaign_lists($camid){
  $rs = db_query("SELECT * FROM {node} n, {gathering_node} gn ".
                 "WHERE n.nid = gn.nid ".
                 "AND gn.camid=%d ".
                 "ORDER BY n.created DESC ".
                 "LIMIT 20",$camid);
  while ($o = db_fetch_object($rs)){
    $nodes[] = $o;
  }
  $out .= form_group("Newest Events",gathering_report_list($nodes));
  
  unset($nodes);
  $rs = db_query("SELECT n.*,gn.*, count(gs.uid) as signups ".
                    "FROM {node} n, {gathering_signup} gs, {gathering_node} gn ".
                    "WHERE n.type = 'gathering-%d' ".
                    "AND n.nid = gn.nid ".
                    "AND n.nid = gs.wid ".
                    "GROUP BY n.nid ".
                    "ORDER BY signups DESC LIMIT 20",$camid);
  while ($o = db_fetch_object($rs)){
    $nodes[] = $o;
  }
  $out .= form_group("Most Attended Events",gathering_report_list($nodes));
  
  return $out; 
}

function gathering_report_campaign_email($camid){
  $rs = db_query("SELECT u.mail FROM {node} n, {users} u WHERE u.uid = n.uid AND n.type='gathering-%d' GROUP BY u.mail",$camid);
  while ($a = db_fetch_array($rs)){
    $coords[] = $a['mail'];
  }
  $coords_out = implode(", ",$coords);

  $out = check_output(t("Copy/paste this into your email program to contact coordinators for all events."));
  $out .= form_textarea("","",$coords_out,40,20);
  return form_group("Coordinator Emails",$out);
}


?>